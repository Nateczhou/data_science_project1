---
title: "Project1"
author: "Wenyu"
date: "10/22/2019"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r, include=F}
h1b <- read.csv('h1b_datahubexport_2009-2019.csv')
str(h1b)
#h1b$State
```

```{r, include=F}
library(dplyr)
library(tidyr)
```
    
```{r,include=F}
#nas <- na.omit(h1b$State)
#nas
new <- h1b %>% drop_na(State) %>% group_by(State) %>%
  summarise(totalinitialapp = sum(Initial.Approvals, na.rm = T),
            totalinitialden = sum(Initial.Denials, na.rm = T),
            totalcontapp = sum(Continuing.Approvals, na.rm = T),
            totalcontden = sum(Continuing.Denials, na.rm = T),
            totalinitial = sum((totalinitialapp + totalinitialden), na.rm = T),
            totalcontinue = sum((totalcontapp+totalcontden), na.rm = T),
            percentiniapp = ((totalinitialapp/totalinitial) ),
            percentiniden = (totalinitialden/totalinitial) * 100,
            percentcontapp = (totalcontapp/totalcontinue) *100,
            percentcontden = (totalcontden/totalcontinue) * 100
            )

test <- h1b %>% drop_na(State) %>% group_by(State) %>%
  summarise(totalinitialapp = sum(Initial.Approvals, na.rm = T))
head(new)
```

```{r, include=F}
library(ggplot2)
library(maps)
library(usmap)
library(openintro)
library(tidyverse)
library(gridExtra)
```

## Chapter 3 States and H1B Visa Status

From the tests, we know that US states and H1B visa status are dependent on each other, therefore, we are interested to find out how the states in the U.S. are related to the H1B visa status. We are using data for both numbers of initial/continue approvals/denials and percentages of initial/continue approvals/denials in every state, this is because we found out some states not only have high numbers of approvals, but also have high numbers of denials. Hence, we used percentages to make the results more accurate.

### 3.1 SMART Question

**What is the relationship between the H1B visa approval and denial rates with the states in the U.S.?**

```{r, include=F}
usstate <- map_data("state")
copy <- map_data("state")
colnames(usstate)[colnames(usstate)=="region"] <- "State_name"
usstate <- usstate %>% mutate(State = state2abbr(State_name))

new$State <- as.character(new$State)
state_lo <- inner_join(usstate, new, by = "State")
state_lo <- state_lo[state_lo$State %in%state.abb,]
head(state_lo)
```

```{r,echo=F}
state_approval <- state_lo %>% select(long, lat, group, order, State, totalinitialapp, percentiniapp, State_name)
head(state_approval)
```

```{r logtest, echo=F}

testLogit <- glm(percentiniapp ~  long + lat + State, data = state_approval, family = "binomial")
summary(testLogit)
```


```{r, echo=F}
state_den <- state_lo %>% select(long, lat, group, order, State, totalinitialden, percentiniden, State_name)
state_contapp <- state_lo %>% select(long, lat, group, order, State, totalcontapp, percentcontapp, State_name)
state_contden <- state_lo %>% select(long, lat, group, order, State, totalcontden, percentcontden, State_name)
```

```{r, echo=F}
us_base <- ggplot(data = state_approval, mapping = aes(x = long, y = lat, group = group)) +
  coord_fixed(1.3) +
  geom_polygon(color = "black", fill = "gray")

#us_base + theme_nothing()

# base <- plot_usmap(regions = "states", data = state_approval, values = NULL, include = NULL, exclude = NULL) +
#   coord_fixed(1.3) +
#   geom_polygon(color = "black", fill = "gray")

ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

elbow_rooml <- us_base + geom_polygon(data = state_approval, aes(fill = totalinitialapp), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

```

### 3.2 Initial Approvals

#### States VS. Numbers of Initial Approvals
```{r, echo=F}
m1 <- new %>% group_by(State) %>% arrange(desc(percentiniapp)) %>% select(State, percentiniapp, totalinitialapp) %>% head()
m2 <- new %>% group_by(State) %>% arrange(desc(totalinitialapp)) %>% select(State, totalinitialapp, percentiniapp) %>% head()
m2
```
#### States VS. Percentage of Initial Approvals
```{r,echo=F}
m1
```

When we sorted the dataset, the top five states with high numbers of initial approvals are Idaho, Vermont, Washington, Rhode Island, and Tennessee. We can also see the percentage next to the initial approvals’ numbers, which shows that even though the five states have high numbers in approvals, they don’t have all high percentages.

The top five states that have high percentages of initial approvals are California, New Jersey, Texas, New York, and Illinois. We can also notice that the numbers of initial approvals next to the percentage column are in a big difference. The big difference indicates that only ranking the states are not an efficient way to find out which state can give overall high initial approval rates when applying for the H1B visas. State “004” is an unknown state, so we don’t need to pay too much attention to it. Moreover, there aren’t any overlaps for the states, thus, plotting the data on a map will give us a more visual way to see which state is more significant in initial approval rates.

#### **3.2.1 Map of Initial Approvals**
```{r, echo=F, message=F}
#elbow_rooml 

elbow_roomll <- us_base + geom_polygon(data = state_approval, aes(fill = percentiniapp), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

eb2 <- elbow_rooml + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = c(min(state_approval$totalinitialapp),1000, 6000, median(state_approval$totalinitialapp), 100000, max(state_approval$totalinitialapp)), trans = "log10", name = "Numbers of Initial Approval") + labs(title = "Map of Numbers of Initial Approvals in Each State")

eb1 <- elbow_roomll + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), name = "Percentage of Initial Approvals", breaks = c(96, 92, 88, 84, min(state_approval$percentiniapp))) + ggtitle("Map of Percentage of Initial Approvals in Each State")

eb2a <- eb2 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Numbers of Initial Approvals in Each State"))

eb1a <- eb1 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Percentage of Initial Approvals in Each State"))

z <- grid.arrange(eb2, eb2a, ncol= 1)
x <- grid.arrange(eb1, eb1a, ncol= 1)

#eb2
#eb2a
#eb1
#eb1a
```

From the above graphs, we want to find the states that have both dense color in every graph. This will show the states have high value in both numbers of initial approvals and the percentage of initial approvals. By comparing the graphs, we find Washington, New York, and Maryland states have dense color, they all have at least 26,000 numbers of initial approvals and around 92% of initial approvals. Therefore, these three states might be better choices to apply for H1B Visas.

### 3.3 Initial Denials

#### **3.3.1 Maps of Initial Denials**
```{r, echo=F, message=F}
elbow_room2 <- us_base + geom_polygon(data = state_den, aes(fill = totalinitialden), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

eb3 <- elbow_room2 + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = c(min(state_den$totalinitialden),1000, 6000, median(state_den$totalinitialden), 100000, max(state_den$totalinitialden)), trans = "log10", name = "Number of Initial Denial") + labs(title = "Map of Numbers of Initial Denials in Each State")
#eb3

elbow_room2l <- us_base + geom_polygon(data = state_den, aes(fill = percentiniden), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

a <- c(4, 8, 12, 16, 19)

eb3l <- elbow_room2l + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = a, name = "Percentage of Initial Denial") + labs(title = "Map of Percentage of Initial Denials in Each State")
#eb3l

eb3a <- eb3 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Numbers of Initial Denials in Each State"))
eb3la <- eb3l + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Percentage of Initial Denials in Each State"))

grid.arrange(eb3, eb3a, ncol = 1)
grid.arrange(eb3l, eb3la, ncol = 1)
```

Since the values for initial denials are the conjugate of initial approvals, therefore, the rankings in the chart for lowest numbers of initial denials and lowest percentage of initial denials are the same with the charts for initial approvals.

By graphing the initial denials, we can find out which state has high initial denial rates when it has dense color in both graphs. Therefore, we notice that Virginia, New Jersey, Georgia, and Florida have relatively high initial denials rate, since they all have at least 6000 numbers of initial denials and around 16% of initial denials.

### 3.4 Continue Approvals
#### States VS. Numbers of Continue Approvals
```{r, echo=F}
m3 <- new %>% group_by(State) %>% arrange(desc(totalcontapp)) %>% head(n = 5) %>% select(State, totalcontapp, percentcontapp)
m3
m4 <- new %>% group_by(State) %>% arrange(desc(percentcontapp)) %>% head(n =9) %>% select(State, percentcontapp, totalcontapp)

m5 <- new %>% group_by(State) %>% arrange(desc(percentcontapp)) %>% select(State, percentcontapp, totalcontapp) %>% filter(totalcontapp > 65000, percentcontapp > 95.00)
#m5
```

#### States VS. Percentage of Continue Approvals
```{r, echo=F}
m4
```

From the tables, we notice that California, Texas, New Jersey, New York, and Illinois have high numbers of continue approvals, and they also have a relatively high percentage of continue approval. This might be due to the policy that continue approval exists if and only if the person has the initial approval for an H1B visa, therefore, the success rate for obtaining a continued approval for an H1B visa is higher than an initial approval.

In the percentage chart, “AE, AP, FM” are U.S. military code, and the blank states are the provinces in Canada, therefore, we can ignore the top four rankings. Vermont, Washington, South Dakota, Mississippi, and Rhode Island are the top five states that have a high percentage rate in continue approvals. However, their numbers of continue approvals are in big difference as well, therefore, it’s better to plot them on a map to visualize them better.

#### **3.4.1 Map of Continue Approvals**
```{r, echo=F, message=F}
elbow_room3 <- us_base + geom_polygon(data = state_contapp, aes(fill = totalcontapp), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

eb4 <- elbow_room3 + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = c(min(state_contapp$totalcontapp),1000, 6000, median(state_contapp$totalcontapp), 100000, max(state_contapp$totalcontapp)), trans = "log10", name = "Numbers of Continue Approval") +
  labs(title = "Map of Numbers of Continue Approvals in Each State") 
#eb4

elbow_room3l <- us_base + geom_polygon(data = state_contapp, aes(fill = percentcontapp), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

eb4l <- elbow_room3l + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), name = "Percentage of Continue Approval") +
  labs(title = "Map of Percentage of Continue Approvals in Each State") 
#eb4l

eb4a <- eb4 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Numbers of Continue Approvals in Each State"))
eb4la <- eb4l + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Percentage of Continue Approvals in Each State"))

grid.arrange(eb4, eb4a, ncol = 1)
grid.arrange(eb4l, eb4la, ncol= 1)
```

From the graphs, we can see that Washington, California, and New York states have dense color in both graphs, they all have at least 67,000 number of continuing approvals, and at least 95% of continue approval rates.

### 3.5 Continue Denials

#### **3.5.1 Map of Continue Denials**
```{r, echo=F, message=F}
elbow_room4 <- us_base + geom_polygon(data = state_contden, aes(fill = totalcontden), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

eb5 <- elbow_room4 + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = c(min(state_contden$totalcontden),1000, 6000, median(state_contden$totalcontden), 100000, max(state_contden$totalcontden)), trans = "log10", name = "Numbers of continue denial") + labs(title = "Map of Numbers of Continue Denials in Each State")
#eb5

elbow_room4l <- us_base + geom_polygon(data = state_contden, aes(fill = percentcontden), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes

eb5l <- elbow_room4l + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), name = "Percentage of continue denial", breaks = c(2, 3, 4, 5, 6, 7, 7.78)) + labs(title = "Map of Percentage of Continue Denials in Each State")
#eb5l

eb5a <- eb5 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Numbers of Continue Denials in Each State"))
eb5la <- eb5l + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Percentage of Continue Denials in Each State"))

grid.arrange(eb5, eb5a, ncol = 1)
grid.arrange(eb5l, eb5la, ncol = 1)
```

Same as initial denials, the lowest number of continue denials and lowest percentage of continue denials are the same with continue approvals, because the number of continue denials is the conjugate of the number of continue approvals.

```{r, echo=F}
m6 <- new %>% group_by(State) %>% arrange(desc(percentcontden)) %>% select(State, percentcontden, totalcontden) %>% filter(totalcontden > 6000, percentcontden > 5.00)
m6
```

Through the table, we can see Pennsylvania, Maryland, Texas, New Jersey and Illinois have high continue denial rates, since they all have at least 6,000 number of continue denials, and above 6% of continue denials.


