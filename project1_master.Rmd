---
title: "H-1B Visa"
author: "Spencer Stucky, Cheng Zeng, Wenyu Zeng, Chao Zhou"
date: "10/14/2019"
output:
  html_document:
    toc: yes
    toc_depth: 4
    fig.align: "center"
    toc_float: yes
    theme: readable
  pdf_document:
    toc: yes
    toc_depth: '4'
---

```{r, include = F}
library(dplyr)
library(maps)
library(tidyr)
library(reshape2)
library(gridExtra)
h1b <- read.csv('h1b_datahubexport_2009-2019.csv')
#h1b <- h1b[h1b$State %in%state.abb,]
```
How have U.S. H1b visa acceptances and denials changed over the course of 2015-2019?1a) How does industry effect H1b visas from the time spanning 2015-2019?

# Chapter 1: Introduction

H-1B visa is a type of non-immigrate visa of United States that under the Immigration and Nationality Act since 1952. This visa allows foreign workers (individual) to enter United Stated to temporarily be employed by U.S. employers in specialty occupations. (Path2usa) With the development of the world, more and more people are looking for opportunities in U.S. Therefore, the number of applications for H-1B are rising every year. Each year, the total number of H-1B petitions that U.S. congress allowed to approve for a fiscal year is 65,000 for regular cap and 20,000 master’s exemption. (USCIS) According to the summary of USCIS H-1B 2019, there are more than 190,000 applications were submitted and 94,213 for regular quota and 95,885 for master quota. (USCIS) However, after Donald Trump become president, he signed the "Buy American, Hire American" executive order in April 2017. (USCIS) Though, this order helps U.S. employers hire most-skills foreign employees, the approval of this visa became harder and harder.

Nonetheless, politics is not the only factor that affects H-1B’s approval rate, but industries and location are also impacting it. In this report, we will explore how different industries, different loactions and different policies affect H-1B's approval rate. A explanation of where, how, why we get this dataset will be given at the beginning. Afterwards, the relationship between industries, locations, policies and approval rate is analysed seperately and the suitable statistical test has been chosen.

# Chapter 2: Description of Data

The dataset is provided for adding a layer of transparency to the H-1B program by U.S. Citizenship and Immigration Services. It is stored as csv files that each file contains information for only one fiscal year. Each row in the dataset contains NAICS code, employer name, city, state, and ZIP code. To process the dataset as dataframe in R, all the origin csv files from USCIS are combined into one single file for data cleaning purpose. According to USCIS, “employers petitioning for temporary foreign workers in specialty occupations must have a certified Labor Condition Application from the Department of Labor and then must submit a Form I-129.” The dataset we used are being collected from these forms by USCIS. Since USCIS transfer these data from these paper forms into electronic system manually, data entry errors is inevitable. Data entry errors may occur in the following fields: employer name, tax ID, state, city, ZIP code. The data field in the dataset will be defined in the following list.

```{r, echo=FALSE}
str(h1b)
```

Fiscal Year: USCIS follows the U.S. Federal Government fiscal year calendar

Employer Name: Petitioner’s employer name

Initial Approval: H-1B petitions with “New employment” or “New concurrent employment” selected on Part 2, Question 2 of the Form I-129 whose first decision is an approval

Initial Denial: H-1B petitions with “New employment” or “New concurrent employment” selected on Part 2, Question 2 of the Form I-129 whose first decision is a denial

Continuing Approval: H-1B petitions with anything other than “New employment” or “New concurrent employment” selected on Part 2, Question 2 of the Form I-129, whose first decision is an approval. This includes, for example, continuing employment, change of employer, and amended petitions

Continuing Denial: H-1B petitions with anything other than “New employment” or “New concurrent employment” selected on Part 2, Question 2 of the Form I-129 whose first decision is a denial. This includes, for example, continuing employment, change of employer, and amended petitions

NAICS: North American Industry Classification System Code

State, City and ZIP: Petitioner’s employer address in the U.S.


```{r chi, echo=F, include=F}
test <- h1b
test$Fiscal.Year <- as.factor(test$Fiscal.Year)
test$NAICS <- as.factor(test$NAICS)
test <- subset(test, select = c(NAICS,State, Initial.Approvals, Initial.Denials, Continuing.Approvals, Continuing.Denials, Fiscal.Year))


tmp <- test %>%
  group_by(Fiscal.Year) %>%
  summarise(ia = sum(Initial.Approvals, na.rm = T), id = sum(Initial.Denials, na.rm=T), ca = sum(Continuing.Approvals, na.rm = T), cd = sum(Continuing.Denials, na.rm = T))
molten.tmp <- melt(tmp, id = "Fiscal.Year", value.name = "Freq",variable.name = "Approval.Type")
cont <- xtabs(Freq ~ Fiscal.Year+Approval.Type, data=molten.tmp)
#cont
res <- chisq.test(cont)
res


tmp1 <- test %>%
  group_by(State) %>%
  summarise(ia = sum(Initial.Approvals, na.rm = T), id = sum(Initial.Denials, na.rm=T), ca = sum(Continuing.Approvals, na.rm = T), cd = sum(Continuing.Denials, na.rm = T))

molten.tmp1 <- melt(tmp1, id = "State", value.name = "Freq",variable.name = "Approval.Type")
#molten.tmp1
cont1 <- xtabs(Freq ~ State+Approval.Type, data=molten.tmp1)
#cont1
res1 <- chisq.test(cont1)
res1

tmp2 <- test %>%
  group_by(NAICS) %>%
  summarise(ia = sum(Initial.Approvals, na.rm = T), id = sum(Initial.Denials, na.rm=T), ca = sum(Continuing.Approvals, na.rm = T), cd = sum(Continuing.Denials, na.rm = T))

molten.tmp2 <- melt(tmp2, id = "NAICS", value.name = "Freq",variable.name = "Approval.Type")
cont2 <- xtabs(Freq ~ NAICS+Approval.Type, data=molten.tmp2)
#cont2
res2 <- chisq.test(cont2)
res2
```


```{r,include=F}
#nas <- na.omit(h1b$State)
#nas
new <- h1b %>% drop_na(State) %>% group_by(State) %>%
  summarise(totalinitialapp = sum(Initial.Approvals, na.rm = T),
            totalinitialden = sum(Initial.Denials, na.rm = T),
            totalcontapp = sum(Continuing.Approvals, na.rm = T),
            totalcontden = sum(Continuing.Denials, na.rm = T),
            totalinitial = sum((totalinitialapp + totalinitialden), na.rm = T),
            totalcontinue = sum((totalcontapp+totalcontden), na.rm = T),
            percentiniapp = ((totalinitialapp/totalinitial) * 100),
            percentiniden = (totalinitialden/totalinitial) * 100,
            percentcontapp = (totalcontapp/totalcontinue) *100,
            percentcontden = (totalcontden/totalcontinue) * 100
            )
test <- h1b %>% drop_na(State) %>% group_by(State) %>%
  summarise(totalinitialapp = sum(Initial.Approvals, na.rm = T))
head(new)
```

```{r, include=F}
library(ggplot2)
library(maps)
library(usmap)
library(openintro)
library(tidyverse)
```

# Chapter 3 Location Factor

From the tests, we know that US states and H1B visa status are dependent on each other, therefore, we are interested to find out how the states in the U.S. are related to the H1B visa status. We are using data for both numbers of initial/continue approvals/denials and percentages of initial/continue approvals/denials in every state, this is because we found out some states not only have high numbers of approvals, but also have high numbers of denials. Hence, we used percentages to make the results more accurate.


### 3.1 SMART Question
**What is the relationship between the H1B visa approval and denial rates with the states in the U.S.?**

```{r, include=F}
usstate <- map_data("state")
copy <- map_data("state")
colnames(usstate)[colnames(usstate)=="region"] <- "State_name"
usstate <- usstate %>% mutate(State = state2abbr(State_name))
new$State <- as.character(new$State)
state_lo <- inner_join(usstate, new, by = "State")
state_lo <- state_lo[state_lo$State %in%state.abb,]
head(state_lo)
```

```{r,include=F}
state_approval <- state_lo %>% select(long, lat, group, order, State, totalinitialapp, percentiniapp, State_name)
head(state_approval)
```

```{r, echo=F}
state_den <- state_lo %>% select(long, lat, group, order, State, totalinitialden, percentiniden, State_name)
state_contapp <- state_lo %>% select(long, lat, group, order, State, totalcontapp, percentcontapp, State_name)
state_contden <- state_lo %>% select(long, lat, group, order, State, totalcontden, percentcontden, State_name)
```


```{r, echo=F}
us_base <- ggplot(data = state_approval, mapping = aes(x = long, y = lat, group = group)) +
  coord_fixed(1.3) +
  geom_polygon(color = "black", fill = "gray")
#us_base + theme_nothing()
# base <- plot_usmap(regions = "states", data = state_approval, values = NULL, include = NULL, exclude = NULL) +
#   coord_fixed(1.3) +
#   geom_polygon(color = "black", fill = "gray")
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )
elbow_rooml <- us_base + geom_polygon(data = state_approval, aes(fill = totalinitialapp), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes
```

### 3.2 Initial Approvals

#### States VS. Numbers of Initial Approvals
```{r, echo=F}
m1 <- new %>% group_by(State) %>% arrange(desc(percentiniapp)) %>% select(State, percentiniapp, totalinitialapp) %>% head()
m2 <- new %>% group_by(State) %>% arrange(desc(totalinitialapp)) %>% select(State, totalinitialapp, percentiniapp) %>% head()
m2
```
#### States VS. Percentage of Initial Approvals
```{r,echo=F}
m1
```

When we sorted the dataset, the top five states with high numbers of initial approvals are Idaho, Vermont, Washington, Rhode Island, and Tennessee. We can also see the percentage next to the initial approvals’ numbers, which shows that even though the five states have high numbers in approvals, they don’t have all high percentages.

The top five states that have high percentages of initial approvals are California, New Jersey, Texas, New York, and Illinois. We can also notice that the numbers of initial approvals next to the percentage column are in a big difference. The big difference indicates that only ranking the states are not an efficient way to find out which state can give overall high initial approval rates when applying for the H1B visas. State “004” is an unknown state, so we don’t need to pay too much attention to it. Moreover, there aren’t any overlaps for the states, thus, plotting the data on a map will give us a more visual way to see which state is more significant in initial approval rates.

#### **3.2.1 Map of Initial Approvals**
```{r, echo=F, message=F}
#elbow_rooml 
elbow_roomll <- us_base + geom_polygon(data = state_approval, aes(fill = percentiniapp), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes
eb2 <- elbow_rooml + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = c(min(state_approval$totalinitialapp),1000, 6000, median(state_approval$totalinitialapp), 100000, max(state_approval$totalinitialapp)), trans = "log10", name = "Numbers of Initial Approval") + labs(title = "Map of Numbers of Initial Approvals in Each State")
eb1 <- elbow_roomll + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), name = "Percentage of Initial Approvals", breaks = c(96, 92, 88, 84, min(state_approval$percentiniapp))) + ggtitle("Map of Percentage of Initial Approvals in Each State")
eb2a <- eb2 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Numbers of Initial Approvals in Each State"))
eb1a <- eb1 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Percentage of Initial Approvals in Each State"))
z <- grid.arrange(eb2, eb2a, ncol= 1)
x <- grid.arrange(eb1, eb1a, ncol= 1)
#eb2
#eb2a
#eb1
#eb1a
```

From the above graphs, we want to find the states that have both dense color in every graph. This will show the states have high value in both numbers of initial approvals and the percentage of initial approvals. By comparing the graphs, we find Washington, New York, and Maryland states have dense color, they all have at least 26,000 numbers of initial approvals and around 92% of initial approvals. Therefore, these three states might be better choices to apply for H1B Visas.

### 3.3 Initial Denials

#### **3.3.1 Maps of Initial Denials**
```{r, echo=F, message=F}
elbow_room2 <- us_base + geom_polygon(data = state_den, aes(fill = totalinitialden), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes
eb3 <- elbow_room2 + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = c(min(state_den$totalinitialden),1000, 6000, median(state_den$totalinitialden), 100000, max(state_den$totalinitialden)), trans = "log10", name = "Number of Initial Denial") + labs(title = "Map of Numbers of Initial Denials in Each State")
#eb3
elbow_room2l <- us_base + geom_polygon(data = state_den, aes(fill = percentiniden), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes
a <- c(4, 8, 12, 16, 19)
eb3l <- elbow_room2l + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = a, name = "Percentage of Initial Denial") + labs(title = "Map of Percentage of Initial Denials in Each State")
#eb3l
eb3a <- eb3 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Numbers of Initial Denials in Each State"))
eb3la <- eb3l + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Percentage of Initial Denials in Each State"))
grid.arrange(eb3, eb3a, ncol = 1)
grid.arrange(eb3l, eb3la, ncol = 1)
```

Since the values for initial denials are the conjugate of initial approvals, therefore, the rankings in the chart for lowest numbers of initial denials and lowest percentage of initial denials are the same with the charts for initial approvals.

By graphing the initial denials, we can find out which state has high initial denial rates when it has dense color in both graphs. Therefore, we notice that Virginia, New Jersey, Georgia, and Florida have relatively high initial denials rate, since they all have at least 6000 numbers of initial denials and around 16% of initial denials.

### 3.4 Continue Approvals
#### States VS. Numbers of Continue Approvals
```{r, echo=F}
m3 <- new %>% group_by(State) %>% arrange(desc(totalcontapp)) %>% head(n = 5) %>% select(State, totalcontapp, percentcontapp)
m3
m4 <- new %>% group_by(State) %>% arrange(desc(percentcontapp)) %>% head(n =9) %>% select(State, percentcontapp, totalcontapp)
m5 <- new %>% group_by(State) %>% arrange(desc(percentcontapp)) %>% select(State, percentcontapp, totalcontapp) %>% filter(totalcontapp > 65000, percentcontapp > 95.00)
#m5
```

#### States VS. Percentage of Continue Approvals
```{r, echo=F}
m4
```

From the tables, we notice that California, Texas, New Jersey, New York, and Illinois have high numbers of continue approvals, and they also have a relatively high percentage of continue approval. This might be due to the policy that continue approval exists if and only if the person has the initial approval for an H1B visa, therefore, the success rate for obtaining a continued approval for an H1B visa is higher than an initial approval.

In the percentage chart, “AE, AP, FM” are U.S. military code, and the blank states are the provinces in Canada, therefore, we can ignore the top four rankings. Vermont, Washington, South Dakota, Mississippi, and Rhode Island are the top five states that have a high percentage rate in continue approvals. However, their numbers of continue approvals are in big difference as well, therefore, it’s better to plot them on a map to visualize them better.

#### **3.4.1 Map of Continue Approvals**
```{r, echo=F, message=F}
elbow_room3 <- us_base + geom_polygon(data = state_contapp, aes(fill = totalcontapp), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes
eb4 <- elbow_room3 + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = c(min(state_contapp$totalcontapp),1000, 6000, median(state_contapp$totalcontapp), 100000, max(state_contapp$totalcontapp)), trans = "log10", name = "Numbers of Continue Approval") +
  labs(title = "Map of Numbers of Continue Approvals in Each State") 
#eb4
elbow_room3l <- us_base + geom_polygon(data = state_contapp, aes(fill = percentcontapp), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes
eb4l <- elbow_room3l + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), name = "Percentage of Continue Approval") +
  labs(title = "Map of Percentage of Continue Approvals in Each State") 
#eb4l
eb4a <- eb4 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Numbers of Continue Approvals in Each State"))
eb4la <- eb4l + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Percentage of Continue Approvals in Each State"))
grid.arrange(eb4, eb4a, ncol = 1)
grid.arrange(eb4l, eb4la, ncol= 1)
```

From the graphs, we can see that Washington, California, and New York states have dense color in both graphs, they all have at least 67,000 number of continuing approvals, and at least 95% of continue approval rates.

### 3.5 Continue Denials

#### **3.5.1 Map of Continue Denials**
```{r, echo=F, message=F}
elbow_room4 <- us_base + geom_polygon(data = state_contden, aes(fill = totalcontden), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes
eb5 <- elbow_room4 + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), breaks = c(min(state_contden$totalcontden),1000, 6000, median(state_contden$totalcontden), 100000, max(state_contden$totalcontden)), trans = "log10", name = "Numbers of continue denial") + labs(title = "Map of Numbers of Continue Denials in Each State")
#eb5
elbow_room4l <- us_base + geom_polygon(data = state_contden, aes(fill = percentcontden), color = "white") +
  geom_polygon(color = "black", fill = NA) +
  theme_bw() +
  ditch_the_axes
eb5l <- elbow_room4l + scale_fill_gradientn(colours = c(low = "white", high = "dark blue"), name = "Percentage of continue denial", breaks = c(2, 3, 4, 5, 6, 7, 7.78)) + labs(title = "Map of Percentage of Continue Denials in Each State")
#eb5l
eb5a <- eb5 + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Numbers of Continue Denials in Each State"))
eb5la <- eb5l + coord_cartesian(xlim = c(-65, -85), ylim = c(35, 45)) + ggtitle(("East Side Zoomed In Version of Percentage of Continue Denials in Each State"))
grid.arrange(eb5, eb5a, ncol = 1)
grid.arrange(eb5l, eb5la, ncol = 1)
```

Same as initial denials, the lowest number of continue denials and lowest percentage of continue denials are the same with continue approvals, because the number of continue denials is the conjugate of the number of continue approvals.

```{r, echo=F}
m6 <- new %>% group_by(State) %>% arrange(desc(percentcontden)) %>% select(State, percentcontden, totalcontden) %>% filter(totalcontden > 6000, percentcontden > 5.00)
m6
```

Through the table, we can see Pennsylvania, Maryland, Texas, New Jersey and Illinois have high continue denial rates, since they all have at least 6,000 number of continue denials, and above 6% of continue denials.










# Chapter 4: Industries Factor

In this Chapter, we are using data to search for the relationship between H-1B approval and denial rate with industry. Also, we compare the rate with industry by year because we attempt to understand whether the year associates with the rate and industry.  

## 4.1: Industries vs NAICS 

In this Chapter, we are seaching for the relationship between industries and NAICS.

### 4.1.1: S.M.A.R.T Question

**Does industry relates to H-1B initial or continuing approval and denial rate between 2009-2019?**

### 4.1.2: Initial Application

To analyze the NAICS and denial rate, we used group by to combine the same industry. Ideally, we want to use the total denial amount to compare the difference in industries. Since the applicant amount of NAICS 54 (Professional, Scientific, and Technical Services) far exceed other industries, we decided to use percentage to present our data.

```{r initial, echo=FALSE} 
library(ggplot2)
h1b$naics = as.factor(h1b$NAICS)
# use group by to combine same industry together to calculate the total initial application amount.
initial <- h1b %>% group_by(naics) %>% summarize( totaliniaccpt = sum(Initial.Approvals, na.rm = T), #shows total number of initail approvals
                                                  totaliniden = sum(Initial.Denials, na.rm = T), # shows total number of initial denials
                                                  totalinitial = sum(Initial.Approvals,na.rm = T)+sum(Initial.Denials,na.rm = T), # shows total number of initial application
                                                  iaccptperc = (totaliniaccpt/totalinitial)*100, # percentage of initial approval rate
                                                  idenperc = (totaliniden/totalinitial)*100) #percentage of initial denial rate
# 
# ggplot(initial, aes(x = naics, y = iaccptperc, color = naics, fill = naics)) + # percentage of initial approvals rate and color by industry code
#   geom_bar(stat ="identity") +
#   xlab("NAICS CODE") +
#   ylab("Total Initial Approvals Percentage")
# 
# ggsave("Total Initial Approvals Percentage.png", width=12, height=9)

ggplot(initial, aes(x = naics, y = idenperc, color = naics,  fill = naics)) + # percentage of initial denials rate and color by industry code
  geom_bar(stat ="identity") + 
  xlab("NAICS CODE") + 
  ylab("Total Initial Denials Percentage") 

#ggsave("Total Denial Approvals Percentage.png", width=12, height=9)


```
From the total initial denial’s percentage, we can see the lowest percentage is 21 – Mining industry, which is only 2.87%; in other word, mining industry has the overall highest initial approval rate. According to NAICS association website that mining includes Oil and Gas Extraction, Coal Mining, Metal Ore Mining and Nonmetallic Mineral Mining and Quarrying. Sue Kihn indicated in his article that mining companies are increasing their budgets on recruiting activities. She believes that seasoned miners are in limited supply after many quit from this industry in leaner times. (Kihn) Even though worldwide has good number of mining-related programs, the industry still requires well-train labor nowadays. Therefore, USCIS is willing to give the H-1B visa to foreign labor so they can help to develop U.S mining industry. (Brandon)

 Nonetheless, 72, Accommodation and Food Services, has the highest initial denial percentage which is 28.19%. Based on NAICS association, hospitality, traveler accommodation, special food services and restaurants are all included. Since most of the companies depends on the season or holiday; thus, majority of these companies only need temporary workers. USCIS provide another type of visa, H-2B, for those temporary non-agricultural workers. In additional, there are many companies are small business, which cannot fulfill the requirement of H-1B, especially after the new policy came out, the application check is harsher. It causes the initial denial rate of Accommodation and Food Services really high. 


### 4.1.3: Continuing Application
```{r continuing, echo=FALSE}
# use group by to combine same industry together to calculate the total continuing application amount.
continuing <- h1b %>% group_by(naics) %>% summarize( totalconaccpt = sum(Continuing.Approvals, na.rm = T),
                                                  totalconden = sum(Continuing.Denials, na.rm = T),
                                                  totalcontinue = sum(Continuing.Approvals,na.rm = T)+sum(Continuing.Denials,na.rm = T),
                                                  caccptperc = (totalconaccpt/totalcontinue) * 100,
                                                  cdenperc = ( totalconden /totalcontinue) * 100 )
# ggplot(continuing, aes(x = naics, y = caccptperc, color = naics, fill = naics)) + geom_bar(stat ="identity") + xlab("NAICS CODE") + ylab("Total Continuing Approvals Percentage")
# ggsave("Total Continuing Approvals Percentage.png", width=12, height=9)

ggplot(continuing, aes(x = naics, y = cdenperc, color = naics, fill = naics)) + geom_bar(stat ="identity") + xlab("NAICS CODE") + ylab("Total Continuing Denials Percentage")

#ggsave("Total Continuing DenialsPercentage.png", width=12, height=9)
```

In the above graph, industry code 99 has the highest continual denials percentage. However, 99 is nonclassifiable establishments which means the industry is unknown. Since the purpose of this section for industry and H1B approval or denial rate, we will not analysis this industry code. 
 Next, we can see the industry 55, Management of Companies and Enterprises, has the lowest continuing denials percentage which is 1.61%. This industry includes Banking, Security and financial companies. Eight major investment banks (such as Bank of American, JPMorgan Chase & Co. and Goldman Sachs Group Inc.) are using the similar way to hire the high-skill employee as tech companies; hence, they increased their H-1B applications for high-skilled workers by almost 60% over five years to more than 7,000 in fiscal year 2017, according to a Bloomberg analysis of visa filing data. (Yang)

## 4.2: Industries vs NAICS by Year

### 4.2.1: Initial Application

```{r fig.width=12, fig.height=9,initialwithyear, echo=F}
#install.packages("directlabels")
library(directlabels)

initialbyyear <- h1b %>% group_by(Fiscal.Year, naics) %>% summarize( totaliniaccpt = sum(Initial.Approvals, na.rm = T),
                                                  totaliniden = sum(Initial.Denials, na.rm = T),
                                                  totalinitial = sum(Initial.Approvals,na.rm = T)+sum(Initial.Denials,na.rm = T),
                                                  iaccptperc = (totaliniaccpt/totalinitial)*100, 
                                                  idenperc = (totaliniden/totalinitial)*100)


ggplot(initialbyyear, aes(x=Fiscal.Year, y=iaccptperc)) + 
    geom_line(aes(color=naics, group=naics), size = 1) +   # create the line by nacis code
    ggtitle("Line Plot of Industry and  Initial Approvals Percentage by Year")+
    geom_point(aes(color=naics), size=3) +  # for visualization purpose, we set up the point for each year so people can directly see the rate change of industry by year 
    theme(plot.title = element_text(hjust = 0.5)) +  # since we change the size of the figer, we need to relocate the fig name to center
    xlab("Year")+ ylab("Percentage(%)")+  # rename x and y axis names
    geom_dl(aes(label = naics, color = naics), method = list(dl.combine("first.polygons", "last.polygons"), cex = 1))+  #set up label for each line
    scale_x_continuous(breaks=seq(2009, 2019, 1))+   # changing the scale for both x and y axis
    scale_y_continuous(breaks=seq(50, 100, 5)) 

#ggsave("iaccptperc.png", width=12, height=9)

#write.csv(initialbyyear, file = "initialbyyear.csv")

# ggplot(initialbyyear, aes(x=Fiscal.Year, y=idenperc)) + 
#     geom_line(aes(color=naics, group=naics), size = 1) + 
#     ggtitle("Line Plot of Industry and  Initial Denials Percentage by Year")+
#     geom_point(aes(color=naics), size=3) +
#     theme(plot.title = element_text(hjust = 0.5)) + 
#     xlab("Year")+ ylab("Percentage(%)")+
#     geom_dl(aes(label = naics, color = naics), method = list(dl.combine("first.polygons", "last.polygons"), cex = 1))+
#     scale_x_continuous(breaks=seq(2009, 2019, 1))+
#     scale_y_continuous(breaks=seq(50, 100, 5))
# ggsave("idenperc.png", width=12, height=9)


```

As shown in the figure, NAICS 54, Professional, Scientific, and Technical Services, increase the initial approval percentage significantly between 2009 to 2010 by 15.68%. This is because the growing job opportunities in these field, especially for information technology services (IT). Regarding the article that Lauren Csorny publish on Bureau of Labor Statistics, employment rate in IT industry has grown by 37% since 2003. During the financial crisis, however, all industries were brain drain. After the recession and market recovery, employment of IT industry has restored and exceed compare to 2008. (Csorny)

 Besides, the initial approval percentage of this industry drop significantly between 2017 to 2018 by 29.37%. The main reason is because of U.S new president, Donald Trump’s executive order, which makes H-1B tougher to get approved. This change directly affects tech companies because most of them rely on H-1B labors. Richard Burke, president and CEO of Envoy Global, conveyed that some companies are looking for labors in U.S, but they couldn’t find sufficient candidates. (Molla) Therefore, the figure shows us IT industry is not the only one got higher denial rate but others also get more denials on H-1B application. 

### 4.2.2: Continuing Application

```{r fig.width=12, fig.height=9, continuewithyear, echo = 0}
#use group by to combine same industry together to calculate the total continuing application amount.
continuingbyyear <- h1b %>% group_by(Fiscal.Year, naics) %>% summarize(totalconaccpt = sum(Continuing.Approvals, na.rm = T),
                                                  totalconden = sum(Continuing.Denials, na.rm = T),
                                                  totalcontinue = sum(Continuing.Approvals,na.rm = T)+sum(Continuing.Denials,na.rm = T),
                                                  caccptperc = (totalconaccpt/totalcontinue) * 100,
                                                  cdenperc = ( totalconden /totalcontinue) * 100 )


ggplot(continuingbyyear, aes(x=Fiscal.Year, y=caccptperc)) + 
    geom_line(aes(color=naics, group=naics), size = 1) + 
    ggtitle("Line Plot of Industry and Continuing Approvals Percentage by Year")+
    geom_point(aes(color=naics), size=3) +
    theme(plot.title = element_text(hjust = 0.5)) + 
    xlab("Year")+ ylab("Percentage(%)")+
    geom_dl(aes(label = naics, color = naics), method = list(dl.combine("first.polygons", "last.polygons"), cex = 1))+
    scale_x_continuous(breaks=seq(2009, 2019, 1))+
    scale_y_continuous(breaks=seq(50, 100, 5))

#ggsave("caccptperc.png", width=12, height=9)

# ggplot(continuingbyyear, aes(x=Fiscal.Year, y=cdenperc)) + 
#     geom_line(aes(color=naics, group=naics),size = 1) + 
#     ggtitle("Line Plot of Industry and Continuing Denials Percentage by Year")+
#     geom_point(aes(color=naics), size=3) +
#     theme(plot.title = element_text(hjust = 0.5)) + 
#     xlab("Year")+ ylab("Percentage(%)")+
#     geom_dl(aes(label = naics, color = naics), method = list(dl.combine("first.polygons", "last.polygons"), cex = 1))+
#     scale_x_continuous(breaks=seq(2009, 2019, 1))+
#     scale_y_continuous(breaks=seq(50, 100, 5))
# 
# ggsave("cdenperc.png", width=12, height=9)

```

The H-1B continuing approval rate for NAICS 11, Agriculture, Forestry, Fishing and Hunting, drop 20.43% in 2018, which decreased the most compare to other industries. These is also due to the new H-1B policy. Since there are more and more paper work need to be submitted by applicants, and the reviewing process takes longer and longer, more agriculture companies shift the visa to H-2A, Temporary Agricultural Workers. 








# Chapter 5: Year, Policy, and H1b Visa Acceptance

  1) How does year affect H1b visa acceptance from 2015-2019? From 2009-19? 1a) How has the change in US policy from 2015-2019 affected H1b visa acceptances and denials?

In this section, we wanted to look at how H1b visa approvals and denials changed over the course of the decade from 2009-2019. In doing so, we analyze both initial and continuing H1b visa approvals and denials. By analyzing over the 10-year time frame, we wanted to get a better look at the broader, overall rate of acceptances across two US presidencies. The idea being, after we looked at the data, we could conclude the fluctuation in rate of acceptances, look at how they changed over the two presidencies, and what policies may have been in place that affected these fluctuations.

```{r initial_bar, echo=FALSE}
library("ggplot2")
h1b$Fiscal.Year = as.factor(h1b$Fiscal.Year)
# use group by to combine same year together to calculate the total initial application amount.
initial <- h1b %>% group_by(Fiscal.Year) %>% summarize( totaliniaccpt = sum(Initial.Approvals, na.rm = T), 
                                                  totaliniden = sum(Initial.Denials, na.rm = T), 
                                                  totalinitial = sum(Initial.Approvals,na.rm = T)+sum(Initial.Denials,na.rm = T), 
                                                  iaccptperc = (totaliniaccpt/totalinitial)*100, round(iaccptperc, digits = 2), 
                                                  idenperc = (totaliniden/totalinitial)*100, round(idenperc, digits = 2)) 

head(initial, n=12)
#str(initial)

ggplot(initial, aes(x = Fiscal.Year, y = iaccptperc, color = Fiscal.Year, fill = Fiscal.Year)) + 
  geom_bar(stat ="identity") + 
  xlab("Year") + 
  ylab("Total Initial Approvals Percentage")+
  ggtitle("Total Initial Approvals by Year")+
ggsave("Total Initial Approvals Percentage.png", width=12, height=9)

ggplot(initial, aes(x = Fiscal.Year, y = idenperc, color = Fiscal.Year, , fill = Fiscal.Year)) + 
  geom_bar(stat ="identity") + 
  xlab("Year") + 
  ylab("Total Initial Denials Percentage")+
  ggtitle("Total Initial Denials by Year")+
ggsave("Total Denial Approvals Percentage.png", width=12, height=9)
```

As was the case with the previous analyses of industry and location, we created a subset of initial approvals, grouped by Fiscal Year. We first coverted the fiscal year variable to a factor level variable using the as.factor function. We then summarized total initial approvals, total initial denials, and total initials to calculate initial approval percentage and initial denial percentage.

We then used the ggplot function to graph fiscal year against initial acceptance percentage. For this bar chart, we found in 2009, initial approval percentage was around 85%, then rose to about 90% and above, before dropping back down in 2016. From 2017 to 2019, initial approval dropped form 87% to 75% - a decrease of over 10 percentage points.

We then graphed fiscal year against total initial denial percentage. From 2012 to 2018, we saw total initial denials jump from 5% to 24%. More specifically, from 2015 to 2019, the data more than tripled from 7% to 23%. Around the time of the change in presidential offices, the total initial denials increased drastically.

```{r cont_bar, echo=FALSE}
# use group by to combine same year together to calculate the total continuing application amount.
continuing <- h1b %>% group_by(Fiscal.Year) %>% summarize( totalconaccpt = sum(Continuing.Approvals, na.rm = T),
                                                  totalconden = sum(Continuing.Denials, na.rm = T),
                                                  totalcontinue = sum(Continuing.Approvals,na.rm = T)+sum(Continuing.Denials,na.rm = T),
                                                  caccptperc = (totalconaccpt/totalcontinue) * 100,
                                                  cdenperc = ( totalconden /totalcontinue) * 100 )
ggplot(continuing, aes(x = Fiscal.Year, y = caccptperc, color = Fiscal.Year, fill = Fiscal.Year)) + geom_bar(stat ="identity") + xlab("Year") + ylab("Total Continuing Approvals Percentage")+
  ggtitle("Total Continuing Approvals by Year")+
ggsave("Total Continuing Approvals Percentage.png", width=12, height=9)

ggplot(continuing, aes(x = Fiscal.Year, y = cdenperc, color = Fiscal.Year, fill = Fiscal.Year)) + geom_bar(stat ="identity") + xlab("Year") + ylab("Total Continuing Denials Percentage")+
  ggtitle("Total Continuing Denials by Year")+
ggsave("Total Continuing DenialsPercentage.png", width=12, height=9)
```

From here, we wanted to analyze how the continuing approval and denials matched up to the initials. We created a new vector labeled “continuing” and grouped by fiscal year. We then summarized and created the following new variables: total continuing approvals, total continuing denials, total continuing, and then continuing approval percentage and continuing denial percentage.

We used a ggplot function to create a bar chart, which showed they largely mirrored the initial approval and denials. The continuing approvals was steady from 2009-2016 at about 90%. From 2017-2019, however, continuing approvals dropped from 93% to 87%. This analysis matched the analysis of initial approvals.

We then graphed a bar chart of total continuing denial percentage and fiscal year. From 2009 to 2019, it doubled from 6% to 12%. In 2013 continuing denials percentage was less than 3%; in 2018 it was about 12%, nearly quadrupling. In 2017 continuing denials was hovering around 5% and in one year, to 2018, it jumped to just shy of 12%. This bar chart largely mirrored what occurred for initial denials from 2009-2019.

```{r ini_line_plot, echo=F, message=F}
#install.packages("directlabels")
library(directlabels)
#h1b$Fiscal.Year = as.numeric(h1b$Fiscal.Year)
initialbyyear <- h1b %>% group_by(Fiscal.Year) %>% summarize( totaliniaccpt = sum(Initial.Approvals, na.rm = T),
                                                  totaliniden = sum(Initial.Denials, na.rm = T),
                                                  totalinitial = sum(Initial.Approvals,na.rm = T)+sum(Initial.Denials,na.rm = T),
                                                  iaccptperc = (totaliniaccpt/totalinitial)*100, 
                                                  idenperc = (totaliniden/totalinitial)*100)
ggplot(initialbyyear, aes(x=Fiscal.Year, y=iaccptperc)) + 
    geom_line(aes(color=Fiscal.Year, group=Fiscal.Year), size = 1) +  
    ggtitle("Line Plot of Initial Approvals Percentage by Year")+
    geom_point(aes(color=Fiscal.Year), size=3) + 
    xlab("Year")+ ylab("Percentage(%)") + 
    ggsave("iaccptpercline.png", width=12, height=9)

initialbyyear <- h1b %>% group_by(Fiscal.Year) %>% summarize( totaliniaccpt = sum(Initial.Approvals, na.rm = T),
                                                  totaliniden = sum(Initial.Denials, na.rm = T),
                                                  totalinitial = sum(Initial.Approvals,na.rm = T)+sum(Initial.Denials,na.rm = T),
                                                  iaccptperc = (totaliniaccpt/totalinitial)*100, 
                                                  idenperc = (totaliniden/totalinitial)*100)
ggplot(initialbyyear, aes(x=Fiscal.Year, y=idenperc)) + 
    geom_line(aes(color=Fiscal.Year, group=Fiscal.Year), size = 1) +   
    ggtitle("Line Plot of Initial Denials Percentage by Year")+
    geom_point(aes(color=Fiscal.Year), size=3) + 
    xlab("Year")+ ylab("Percentage(%)") + 
    ggsave("idenpercline.png", width=12, height=9)
```

From here, we wanted to visualize the data a bit differently. For initials, we used the same “initial” subset, called it “initialbyyear,” used fiscal year as a factor level variable, and summarized the initial approvals and denials as before.

For initial approval percentage by fiscal year, we plotted a line graph and the data displayed the same as the bar chart, demonstrating an inverse-U relationship (roughly). Initial denial percentage displayed a U shape relationship, the same as with the initial denials for the bar chart.

```{r cont_line_plot, echo=F, message=F}
library(directlabels)
continuing <- h1b %>% group_by(Fiscal.Year) %>% summarize( totalconaccpt = sum(Continuing.Approvals, na.rm = T),
                                                  totalconden = sum(Continuing.Denials, na.rm = T),
                                                  totalcontinue = sum(Continuing.Approvals,na.rm = T)+sum(Continuing.Denials,na.rm = T),
                                                  caccptperc = (totalconaccpt/totalcontinue) * 100,
                                                  cdenperc = ( totalconden /totalcontinue) * 100 )
ggplot(continuing, aes(x=Fiscal.Year, y=caccptperc)) + 
    geom_line(aes(color=Fiscal.Year, group=Fiscal.Year), size = 1) +   # create the line by nacis code
    ggtitle("Line Plot of Continuing Acceptance Percentage by Year")+
    geom_point(aes(color=Fiscal.Year), size=3) + 
    xlab("Year")+ ylab("Percentage(%)") + 
    ggsave("conaccptercline.png", width=12, height=9)      

continuing <- h1b %>% group_by(Fiscal.Year) %>% summarize( totalconaccpt = sum(Continuing.Approvals, na.rm = T),
                                                  totalconden = sum(Continuing.Denials, na.rm = T),
                                                  totalcontinue = sum(Continuing.Approvals,na.rm = T)+sum(Continuing.Denials,na.rm = T),
                                                  caccptperc = (totalconaccpt/totalcontinue) * 100,
                                                  cdenperc = ( totalconden /totalcontinue) * 100 )
ggplot(continuing, aes(x=Fiscal.Year, y=cdenperc)) + 
    geom_line(aes(color=Fiscal.Year, group=Fiscal.Year), size = 1) +   # create the line by nacis code
    ggtitle("Line Plot of Continuing Denial Percentage by Year")+
    geom_point(aes(color=Fiscal.Year), size=3) + 
    xlab("Year")+ ylab("Percentage(%)") + 
    ggsave("condenline.png", width=12, height=9)    
```

For continuing, we used the same “continuing” subset created earlier. For continuing approval percentage, the line graph displayed an inverse U relationship, mirroring the bar chart from earlier. We then graphed continuing denial percentage by year, the line graph showed a U-shaped relationship like the bar chart from above.

#Analysis and Policy

When looking at these analyses, the data showed some consistent messages. Overall, from 2015 to 2019 initial denial rate tripled from 7% to 23%. As well, from 2015 to 2019 continuing denial quadrupled from 3% to 12%. Under Obama’s policies from 2010 to 2015, the denial rate never went over 8%. Furthermore, after running chi squared tests and determining the significance levels of fiscal year and initial approvals, initial denials, continuing approvals, and continuing denials, we could determine some relationships from the data. All chi squared tests had a very small p value less than .001, at <2e-16, demonstrating the statistical significance of each test on the variables. For both the line graphs and bar charts, for initial approvals and continuing approvals drastically decreased after 2017. For both initial denials and continuing denials, the data showed a sharp increase around 2017.

What was the cause of this? Here’s where policy comes into play. Trump won the presidential nomination in late 2016, was inaugurated in early 2017, and in April of 2017 signed the “Buy American and Hire American” executive order. This effectively changed the H1b visa acceptance requirement from a “skill-based” system to a “merit-based” system. This made the approval process into a more subjective and ambiguous decision-making process. From this, the “standard of proof” had be raised, making it much harder for immigrants to gain temporary citizenship status in the US. This move has affected multiple industries across various locations in the US – impacting the labor market and production potential in certain industries. Finally, this move largely coincided with Trump’s protectionist and anti-immigration platform he ran on during his presidential campaign. Hence while the executive order should come as no surprise, the data does indeed suggest that Trump’s policy has significantly effected H1b visa approval rates since he came into office, which has had cascading effects on US immigration, labor, and economics.




# Chapter 6: Conculsion 

To conclude, there are limited statistical test suitable for this dataset since most of the variables are catogorical variables. The only test that describes the relationship between these variables are chi square test. Logistic model may also apply to the data. 



# Citation

What is H1B Visa? (n.d.). Retrieved October 14, 2019, from https://www.path2usa.com/what-is-h1b-visa.

 USCIS Reaches FY 2019 H-1B Cap. (2018, April 6). Retrieved October 14, 2019, from https://www.uscis.gov/news/alerts/uscis-reaches-fy-2019-h-1b-cap.

 Buy American and Hire American. (2019, April 26). Retrieved October 14, 2019, from https://www.uscis.gov/legal-resources/buy-american-hire-american-putting-american-workers-first.

 Kumar. (2019, May 26). H1B Historical Data – Lottery vs 85K Quota, Masters vs Regular Split. Retrieved October 22, 2019, from https://redbus2us.com/h1b-historical-data-lottery-vs-85k-quota-masters-vs-regular-split/.

 Search NAICS Codes by Industry. (n.d.). Retrieved October 15, 2019, from https://www.naics.com/search-naics-codes-by-industry/.

 SIC Major Group: 99 Nonclassifiable Establishments. (n.d.). Retrieved October 21, 2019, from https://www.naics.com/standard-industrial-code-divisions/?code=99.

 Zaveri, P., & Roy, A. (2019, April 2). Changes to H-1B visa lottery create 'stress' for tech companies and employees. Retrieved October 22, 2019, from https://www.cnbc.com/2019/04/01/h1-b-lottery-changes-in-2018-masters-candidates-more-inspections.html.

 Yang, Y. (2018, February 22). Big Banks in U.S. Forced to Reevaluate Hiring Foreign Workers. Retrieved October 23, 2019, from https://www.bloomberg.com/news/articles/2018-02-22/big-banks-in-u-s-forced-to-reevaluate-hiring-foreign-workers.

 Kihn, S. (2018, July 8). Demand for mining staff spans all levels and skills. Retrieved October 23, 2019, from http://www.mining.com/demand-mining-staff-spans-levels-skills/.

 Brandon, C. N. (2012). Emerging Workforce Trends in the U.S. Mining Industry. Retrieved from https://www.smenet.org/SME/media/Government/201201_EmergingWorkforceTrendsinUSMiningIndustry.pdf

 Csorny, L. (2013, April). Careers in the growing field of information technology services : Beyond the Numbers. Retrieved October 23, 2019, from https://www.bls.gov/opub/btn/volume-2/careers-in-growing-field-of-information-technology-services.htm.

 Molla, R. (2019, February 28). Visa approvals for tech workers are on the decline. That won't just hurt Silicon Valley. Retrieved October 23, 2019, from https://www.vox.com/2019/2/28/18241522/trump-h1b-tech-work-jobs-overseas.
 
 https://nfap.com/wp-content/uploads/2019/04/H-1B-Denial-Rates-Past-and-Present.NFAP-Policy-Brief.April-2019.pdf
 
https://economictimes.indiatimes.com/nri/visa-and-immigration/10-per-cent-drop-in-h1b-visa-approvals-in-2018-us-authorities/articleshow/69659107.cms

https://www.forbes.com/sites/stuartanderson/2019/04/10/new-data-show-h-1b-denial-rates-reaching-highest-levels/#38e210e2797f